# CircleCI job.
# Author: Ramesh Doddi

description: >
  Analyzes the code using sonar stack and publishes report to sonar repository.

executor: openjdk

working_directory: ~/project

parameters:
  mvn_opts:
    type: string
    default: ''
    description: >
      Maven command line override options,
      helpful to centralize private repo config like (-s .circleci/mvn-settings.xml).
  project_key:
    type: string
    default: ${CIRCLE_PROJECT_REPONAME}
    description: >
      Sonar project key (set this at your sonarcloud account and supply here). Default is project repo name.
  token:
    type: string
    default: ''
    description: >
      Provide sonar login token (create this at your sonarcloud account).

steps:
  - checkout
  - run:
      environment:
        MVN_OPTS: << parameters.mvn_opts >>
        PROJECT_KEY: << parameters.project_key >>
        TOKEN: << parameters.token >>
      name: Publish code coverage report to sonarcloud
      # command: <<include(scripts/sonar-analyze.sh)>>
      command: >
        mvn "${MVN_OPTS}" verify sonar:sonar \
          -Dsonar.projectKey="${PROJECT_KEY}" \
          -Dsonar.login=${TOKEN}
